<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLM Position Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2em;
    }

    .subtitle {
      color: #666;
      font-size: 1em;
    }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 0.85em;
      color: #666;
      font-weight: 600;
    }

    select, button {
      padding: 10px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.3s;
    }

    select:hover, select:focus {
      border-color: #667eea;
      outline: none;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      font-weight: 600;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .stat-label {
      font-size: 0.85em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-subtext {
      font-size: 0.9em;
      color: #999;
      margin-top: 5px;
    }

    .positions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .position-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      border-left: 5px solid #667eea;
    }

    .position-card.out-of-range {
      border-left-color: #f44336;
    }

    .position-card.in-range {
      border-left-color: #4caf50;
    }

    .position-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .position-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .position-pair {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
    }

    .position-protocol {
      font-size: 0.75em;
      color: white;
      background: #667eea;
      padding: 4px 10px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .position-status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      margin-top: 8px;
    }

    .status-in-range {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-out-of-range {
      background: #ffebee;
      color: #c62828;
    }

    .position-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .metric {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .metric-label {
      font-size: 0.75em;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
    }

    .range-bar {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }

    .range-bar-label {
      font-size: 0.75em;
      color: #999;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .range-bar-container {
      position: relative;
      height: 30px;
      background: linear-gradient(to right, #ffebee 0%, #e8f5e9 50%, #ffebee 100%);
      border-radius: 15px;
      overflow: hidden;
    }

    .range-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 4px;
      height: 40px;
      background: #333;
      z-index: 2;
    }

    .range-marker::after {
      content: '';
      position: absolute;
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid #333;
    }

    .range-bounds {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 0.75em;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .empty-state h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.5em;
    }

    .empty-state p {
      color: #999;
      font-size: 1em;
    }

    .timestamp {
      font-size: 0.75em;
      color: #999;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .positions-grid {
        grid-template-columns: 1fr;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“Š CLM Position Dashboard</h1>
      <p class="subtitle">Monitor your concentrated liquidity positions across all protocols</p>
    </header>

    <div class="filters">
      <div class="filter-group">
        <label>Protocol</label>
        <select id="protocolFilter">
          <option value="all">All Protocols</option>
          <option value="Orca">Orca</option>
          <option value="Raydium">Raydium</option>
          <option value="Aerodrome">Aerodrome</option>
          <option value="Cetus">Cetus</option>
          <option value="Hyperion">Hyperion</option>
          <option value="PancakeSwap">PancakeSwap</option>
          <option value="Beefy">Beefy</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Status</label>
        <select id="statusFilter">
          <option value="all">All Positions</option>
          <option value="in-range">In Range</option>
          <option value="out-of-range">Out of Range</option>
        </select>
      </div>

      <button id="refreshBtn">ðŸ”„ Refresh Data</button>
      <button id="exportBtn">ðŸ“¥ Export Data</button>
    </div>

    <div class="stats" id="stats"></div>

    <div class="positions-grid" id="positionsGrid"></div>

    <div class="empty-state" id="emptyState" style="display: none;">
      <h3>No positions found</h3>
      <p>Use the browser extension to capture your CLM positions from supported protocols.</p>
    </div>
  </div>

  <script>
    let allCaptures = [];
    let filteredPositions = [];

    // Load captures from Chrome storage
    function loadCaptures() {
      chrome.storage.local.get(['captures'], (result) => {
        allCaptures = result.captures || [];
        applyFilters();
      });
    }

    // Apply filters and update display
    function applyFilters() {
      const protocolFilter = document.getElementById('protocolFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      // Get all positions from all captures
      const allPositions = [];
      allCaptures.forEach(capture => {
        if (capture.data?.content?.clmPositions?.positions) {
          capture.data.content.clmPositions.positions.forEach(pos => {
            allPositions.push({
              ...pos,
              protocol: capture.protocol,
              captureTimestamp: capture.timestamp,
              url: capture.url
            });
          });
        }
      });

      // Apply filters
      filteredPositions = allPositions.filter(pos => {
        const matchesProtocol = protocolFilter === 'all' || pos.protocol === protocolFilter;
        const matchesStatus = statusFilter === 'all' ||
          (statusFilter === 'in-range' && pos.inRange) ||
          (statusFilter === 'out-of-range' && !pos.inRange);
        return matchesProtocol && matchesStatus;
      });

      updateStats();
      renderPositions();
    }

    // Update statistics cards
    function updateStats() {
      const totalPositions = filteredPositions.length;
      const inRangeCount = filteredPositions.filter(p => p.inRange).length;
      const outOfRangeCount = filteredPositions.filter(p => !p.inRange).length;
      const totalValue = filteredPositions.reduce((sum, p) => sum + (p.balance || 0), 0);
      const totalPendingYield = filteredPositions.reduce((sum, p) => sum + (p.pendingYield || 0), 0);
      const avgAPY = filteredPositions.length > 0
        ? filteredPositions.reduce((sum, p) => sum + (p.apy || 0), 0) / filteredPositions.length
        : 0;

      const statsHTML = `
        <div class="stat-card">
          <div class="stat-label">Total Positions</div>
          <div class="stat-value">${totalPositions}</div>
          <div class="stat-subtext">${inRangeCount} in range, ${outOfRangeCount} out of range</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Value</div>
          <div class="stat-value">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
          <div class="stat-subtext">Across all positions</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pending Yield</div>
          <div class="stat-value">$${totalPendingYield.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
          <div class="stat-subtext">Ready to claim</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average APY</div>
          <div class="stat-value">${avgAPY.toFixed(1)}%</div>
          <div class="stat-subtext">Across all positions</div>
        </div>
      `;

      document.getElementById('stats').innerHTML = statsHTML;
    }

    // Render position cards
    function renderPositions() {
      const grid = document.getElementById('positionsGrid');
      const emptyState = document.getElementById('emptyState');

      if (filteredPositions.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      grid.style.display = 'grid';
      emptyState.style.display = 'none';

      const positionsHTML = filteredPositions.map(pos => {
        const inRange = pos.inRange;
        const rangeStatusClass = inRange ? 'in-range' : 'out-of-range';
        const statusClass = inRange ? 'status-in-range' : 'status-out-of-range';
        const statusText = inRange ? 'âœ“ In Range' : 'âš  Out of Range';

        // Calculate position of current price marker on the range bar
        let markerPosition = 50; // default to middle
        if (pos.rangeMin !== undefined && pos.rangeMax !== undefined && pos.currentPrice !== undefined) {
          const range = pos.rangeMax - pos.rangeMin;
          if (range > 0) {
            const pricePosition = (pos.currentPrice - pos.rangeMin) / range;
            markerPosition = Math.max(0, Math.min(100, pricePosition * 100));
          }
        }

        return `
          <div class="position-card ${rangeStatusClass}">
            <div class="position-header">
              <div>
                <div class="position-pair">${pos.pair || 'Unknown Pair'}</div>
                <span class="position-status ${statusClass}">${statusText}</span>
              </div>
              <span class="position-protocol">${pos.protocol}</span>
            </div>

            <div class="position-metrics">
              <div class="metric">
                <span class="metric-label">Balance</span>
                <span class="metric-value">$${(pos.balance || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
              </div>
              <div class="metric">
                <span class="metric-label">APY</span>
                <span class="metric-value">${(pos.apy || 0).toFixed(2)}%</span>
              </div>
              <div class="metric">
                <span class="metric-label">Pending Yield</span>
                <span class="metric-value">${pos.pendingYield !== undefined ? '$' + (pos.pendingYield || 0).toFixed(2) : 'N/A'}</span>
              </div>
              <div class="metric">
                <span class="metric-label">Current Price</span>
                <span class="metric-value">${pos.currentPrice !== undefined ? pos.currentPrice.toFixed(4) : 'N/A'}</span>
              </div>
            </div>

            ${pos.rangeMin !== undefined && pos.rangeMax !== undefined ? `
            <div class="range-bar">
              <div class="range-bar-label">Price Range</div>
              <div class="range-bar-container">
                <div class="range-marker" style="left: ${markerPosition}%"></div>
              </div>
              <div class="range-bounds">
                <span>Min: ${pos.rangeMin.toFixed(4)}</span>
                <span>Max: ${pos.rangeMax.toFixed(4)}</span>
              </div>
            </div>
            ` : ''}

            <div class="timestamp">Captured: ${new Date(pos.captureTimestamp).toLocaleString()}</div>
          </div>
        `;
      }).join('');

      grid.innerHTML = positionsHTML;
    }

    // Export data as JSON
    function exportData() {
      const dataStr = JSON.stringify(filteredPositions, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

      const a = document.createElement('a');
      a.href = url;
      a.download = `clm-positions-${timestamp}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

    // Event listeners
    document.getElementById('protocolFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('refreshBtn').addEventListener('click', loadCaptures);
    document.getElementById('exportBtn').addEventListener('click', exportData);

    // Initial load
    loadCaptures();
  </script>
</body>
</html>
